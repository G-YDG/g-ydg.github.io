<!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>Swoole常用配置 | YddBlog</title><meta name="description" content="reactor_num设置启动的 Reactor 线程数。【默认值：CPU 核数】。 通过此参数来调节主进程内事件处理线程的数量，以充分利用多核。默认会启用 CPU 核数相同的数量。Reactor 线程是可以利用多核，如：机器有 128 核，那么底层会启动 128 线程。每个线程能都会维持一个 EventLoop。线程之间是无锁的，指令可以被 128 核 CPU 并行执行。考虑到操作系统调度存在一"><meta property="og:type" content="article"><meta property="og:title" content="Swoole常用配置"><meta property="og:url" content="https://g-ydg.github.io/2023/03/24/Swoole%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/index.html"><meta property="og:site_name" content="ydd"><meta property="og:description" content="reactor_num设置启动的 Reactor 线程数。【默认值：CPU 核数】。 通过此参数来调节主进程内事件处理线程的数量，以充分利用多核。默认会启用 CPU 核数相同的数量。Reactor 线程是可以利用多核，如：机器有 128 核，那么底层会启动 128 线程。每个线程能都会维持一个 EventLoop。线程之间是无锁的，指令可以被 128 核 CPU 并行执行。考虑到操作系统调度存在一"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2023-03-24T19:39:00.000Z"><meta property="article:modified_time" content="2025-11-02T01:28:30.427Z"><meta property="article:author" content="Ydd"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://g-ydg.github.io/2023/03/24/Swoole%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/index.html"><link rel="alternate" href="/atom.xml" title="ydd" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><meta name="generator" content="Hexo 5.4.2"></head><body class="main-center theme-purple" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav menu-highlight"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-repository"><a href="/repository"><i class="icon icon-project"></i> <span class="menu-title">项目</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/g-ydg" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><p>欢迎交流与分享经验!</p></div></div></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">九月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">五月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">四月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">三月 2023</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">二月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">十二月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">十一月 2022</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/07/">七月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">十二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/11/">十一月 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">十月 2021</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/09/">九月 2021</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/08/">八月 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a><span class="archive-list-count">5</span></li></ul></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2023/09/03/Wechaty+ChatGPT%20%E5%AE%9E%E7%8E%B0%E4%B8%AA%E4%BA%BA%E8%81%8A%E5%A4%A9%E6%9C%BA%E5%99%A8%E4%BA%BA/" class="title">Wechaty+ChatGPT 实现个人聊天机器人</a></p><p class="item-date"><time datetime="2023-09-03T22:32:07.000Z" itemprop="datePublished">2023-09-04</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2023/05/17/%E9%98%BF%E9%87%8C%E4%BA%91CLI/" class="title">阿里云CLI</a></p><p class="item-date"><time datetime="2023-05-17T22:49:05.000Z" itemprop="datePublished">2023-05-18</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2023/04/03/Kubernetes%20Tutorials%20%EF%BD%9C%20k8s%20%E6%95%99%E7%A8%8B/" class="title">Kubernetes Tutorials ｜ k8s 教程</a></p><p class="item-date"><time datetime="2023-04-03T18:13:01.000Z" itemprop="datePublished">2023-04-04</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2023/04/02/COS%20+%20Github%20Actions%20%E5%AE%9E%E7%8E%B0%E8%AF%AD%E9%9B%80%E8%87%AA%E5%8A%A8%E5%8F%91%E5%B8%83/" class="title">COS + Github Actions 实现语雀自动发布</a></p><p class="item-date"><time datetime="2023-04-02T23:17:38.000Z" itemprop="datePublished">2023-04-03</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="/2023/03/30/Hexo%E5%90%8C%E6%AD%A5%E8%AF%AD%E9%9B%80%E6%96%87%E7%AB%A0/" class="title">Hexo同步语雀文章</a></p><p class="item-date"><time datetime="2023-03-30T23:40:30.000Z" itemprop="datePublished">2023-03-31</time></p></div></li></ul></div></div></div></aside><main class="main" role="main"><div class="content"><article id="post-Swoole常用配置" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">Swoole常用配置</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2023/03/24/Swoole%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/" class="article-date"><time datetime="2023-03-24T19:39:00.000Z" itemprop="datePublished">2023-03-25</time> </a></span><span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span> </span></span><span class="post-comment"><i class="icon icon-comment"></i> <a href="/2023/03/24/Swoole%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/#comments" class="article-comment-link">评论</a></span> <span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 2.9k(字)</span> <span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 11(分)</span></div></div><div class="article-entry marked-body" itemprop="articleBody"><h2 id="reactor-num"><a href="#reactor-num" class="headerlink" title="reactor_num"></a>reactor_num</h2><p><strong><font style="color:#2c3e50">设置启动的 </font></strong><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/learn?id=reactor%e7%ba%bf%e7%a8%8b">Reactor</a><strong><font style="color:#2c3e50"> 线程数。</font></strong><font style="color:#34495e">【默认值：</font><font style="color:#e96900;background-color:#f8f8f8">CPU</font><font style="color:#34495e"> 核数】。</font></p><p><font style="color:#34495e">通过此参数来调节主进程内事件处理线程的数量，以充分利用多核。默认会启用 </font><font style="color:#e96900;background-color:#f8f8f8">CPU</font><font style="color:#34495e"> 核数相同的数量。</font><br><font style="color:#e96900;background-color:#f8f8f8">Reactor</font><font style="color:#34495e"> 线程是可以利用多核，如：机器有 </font><font style="color:#e96900;background-color:#f8f8f8">128</font><font style="color:#34495e"> 核，那么底层会启动 </font><font style="color:#e96900;background-color:#f8f8f8">128</font><font style="color:#34495e"> 线程。</font><br><font style="color:#34495e">每个线程能都会维持一个 </font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/learn?id=%e4%bb%80%e4%b9%88%e6%98%afeventloop">EventLoop</a><font style="color:#34495e">。线程之间是无锁的，指令可以被 </font><font style="color:#e96900;background-color:#f8f8f8">128</font><font style="color:#34495e"> 核 </font><font style="color:#e96900;background-color:#f8f8f8">CPU</font><font style="color:#34495e"> 并行执行。</font><br><font style="color:#34495e">考虑到操作系统调度存在一定程度的性能损失，可以设置为 CPU 核数 * 2，以便最大化利用 CPU 的每一个核。</font></p><ul><li><strong><font style="color:#2c3e50">提示</font></strong><ul><li><font style="color:#e96900;background-color:#f8f8f8">reactor_num</font><font style="color:#34495e"> </font><font style="color:#34495e">建议设置为</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">CPU</font><font style="color:#34495e"> </font><font style="color:#34495e">核数的</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">1-4</font><font style="color:#34495e"> </font><font style="color:#34495e">倍</font></li><li><font style="color:#e96900;background-color:#f8f8f8">reactor_num</font><font style="color:#34495e"> 最大不得超过 </font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/functions?id=swoole_cpu_num">swoole_cpu_num()</a><font style="color:#34495e"> * 4</font></li></ul></li><li><strong><font style="color:#2c3e50">注意</font></strong></li></ul><blockquote><p><font style="color:#e96900;background-color:#efefef">reactor_num</font><font style="color:#34495e;background-color:#f8f8f8"> 必须小于或等于 </font><font style="color:#e96900;background-color:#efefef">worker_num</font><font style="color:#34495e;background-color:#f8f8f8"> ；<br></font><font style="color:#34495e;background-color:#f8f8f8">如果设置的 </font><font style="color:#e96900;background-color:#efefef">reactor_num</font><font style="color:#34495e;background-color:#f8f8f8"> 大于 </font><font style="color:#e96900;background-color:#efefef">worker_num</font><font style="color:#34495e;background-color:#f8f8f8">，会自动调整使 </font><font style="color:#e96900;background-color:#efefef">reactor_num</font><font style="color:#34495e;background-color:#f8f8f8"> 等于 </font><font style="color:#e96900;background-color:#efefef">worker_num</font><font style="color:#34495e;background-color:#f8f8f8"> ；<br></font><font style="color:#34495e;background-color:#f8f8f8">在超过 </font><font style="color:#e96900;background-color:#efefef">8</font><font style="color:#34495e;background-color:#f8f8f8"> 核的机器上 </font><font style="color:#e96900;background-color:#efefef">reactor_num</font><font style="color:#34495e;background-color:#f8f8f8"> 默认设置为 </font><font style="color:#e96900;background-color:#efefef">8</font><font style="color:#34495e;background-color:#f8f8f8">。</font></p></blockquote><h2 id="worker-num"><a href="#worker-num" class="headerlink" title="worker_num"></a>worker_num</h2><p><strong><font style="color:#2c3e50">设置启动的 </font>**</strong><font style="color:#e96900;background-color:#f8f8f8">Worker</font>*<strong>*<font style="color:#2c3e50"> 进程数。</font></strong><font style="color:#34495e">【默认值：</font><font style="color:#e96900;background-color:#f8f8f8">CPU</font><font style="color:#34495e"> 核数】</font></p><p><font style="color:#34495e">如 </font><font style="color:#e96900;background-color:#f8f8f8">1</font><font style="color:#34495e"> 个请求耗时 </font><font style="color:#e96900;background-color:#f8f8f8">100ms</font><font style="color:#34495e">，要提供 </font><font style="color:#e96900;background-color:#f8f8f8">1000QPS</font><font style="color:#34495e"> 的处理能力，那必须配置 </font><font style="color:#e96900;background-color:#f8f8f8">100</font><font style="color:#34495e"> 个进程或更多。</font><br><font style="color:#34495e">但开的进程越多，占用的内存就会大大增加，而且进程间切换的开销就会越来越大。所以这里适当即可。不要配置过大。</font></p><ul><li><strong><font style="color:#2c3e50">提示</font></strong><ul><li><font style="color:#34495e">如果业务代码是全</font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/learn?id=%e5%90%8c%e6%ad%a5io%e5%bc%82%e6%ad%a5io">异步 IO</a><font style="color:#34495e"> 的，这里设置为 </font><font style="color:#e96900;background-color:#f8f8f8">CPU</font><font style="color:#34495e"> 核数的 </font><font style="color:#e96900;background-color:#f8f8f8">1-4</font><font style="color:#34495e"> 倍最合理</font></li><li><font style="color:#34495e">如果业务代码为</font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/learn?id=%e5%90%8c%e6%ad%a5io%e5%bc%82%e6%ad%a5io">同步 IO</a><font style="color:#34495e">，需要根据请求响应时间和系统负载来调整，例如：</font><font style="color:#e96900;background-color:#f8f8f8">100-500</font><font style="color:#34495e"></font></li><li><font style="color:#34495e">默认设置为 </font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/functions?id=swoole_cpu_num">swoole_cpu_num()</a><font style="color:#34495e">，最大不得超过 </font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/functions?id=swoole_cpu_num">swoole_cpu_num()</a><font style="color:#34495e"> * 1000</font></li><li><font style="color:#34495e">假设每个进程占用 </font><font style="color:#e96900;background-color:#f8f8f8">40M</font><font style="color:#34495e"> 内存，</font><font style="color:#e96900;background-color:#f8f8f8">100</font><font style="color:#34495e"> 个进程就需要占用 </font><font style="color:#e96900;background-color:#f8f8f8">4G</font><font style="color:#34495e"> 内存</font></li></ul></li></ul><h2 id="max-request"><a href="#max-request" class="headerlink" title="max_request"></a>max_request</h2><p><strong><font style="color:#2c3e50">设置 </font>**</strong><font style="color:#e96900;background-color:#f8f8f8">worker</font>*<strong>*<font style="color:#2c3e50"> 进程的最大任务数。</font></strong><font style="color:#34495e">【默认值：</font><font style="color:#e96900;background-color:#f8f8f8">0</font><font style="color:#34495e"> 即不会退出进程】。</font></p><p><font style="color:#34495e">一个 </font><font style="color:#e96900;background-color:#f8f8f8">worker</font><font style="color:#34495e"> 进程在处理完超过此数值的任务后将自动退出，进程退出后会释放所有内存和资源。</font></p><blockquote><p>这个参数的主要作用是解决由于程序编码不规范导致的 PHP 进程内存泄露问题。PHP 应用程序有缓慢的内存泄漏，但无法定位到具体原因、无法解决，可以通过设置 max_request 临时解决，需要找到内存泄漏的代码并修复，而不是通过此方案。</p><p>设置此参数可能会产生的影响：</p><ul><li>客户端重连（BASE 模式）</li><li>内存峰值大</li><li>无法常驻内存</li><li>首次请求慢（opcache， ext minits）</li></ul></blockquote><ul><li><strong><font style="color:#2c3e50">提示</font></strong><ul><li><font style="color:#34495e">达到 </font><font style="color:#e96900;background-color:#efefef">max_request</font><font style="color:#34495e"> 不一定马上关闭进程，参考 </font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/server/setting?id=max_wait_time">max_wait_time</a><font style="color:#34495e"></font></li><li><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/learn?id=swoole_base">SWOOLE_BASE</a><font style="color:#34495e"> 下，达到 max_request 重启进程会导致客户端连接断开</font></li></ul></li></ul><blockquote><p><font style="color:#34495e;background-color:#f8f8f8">当 </font><font style="color:#e96900;background-color:#efefef">worker</font><font style="color:#34495e;background-color:#f8f8f8"> 进程内发生致命错误或者人工执行 </font><font style="color:#e96900;background-color:#efefef">exit</font><font style="color:#34495e;background-color:#f8f8f8"> 时，进程会自动退出。</font><font style="color:#e96900;background-color:#efefef">master</font><font style="color:#34495e;background-color:#f8f8f8"> 进程会重新启动一个新的</font><font style="color:#e96900;background-color:#efefef">worker</font><font style="color:#34495e;background-color:#f8f8f8"> 进程来继续处理请求。</font></p></blockquote><h2 id="max-conn-max-connection"><a href="#max-conn-max-connection" class="headerlink" title="max_conn (max_connection)"></a>max_conn (max_connection)</h2><p><strong><font style="color:#2c3e50">服务器程序，最大允许的连接数。</font></strong><font style="color:#34495e">【默认值：</font><font style="color:#e96900;background-color:#f8f8f8">ulimit -n</font><font style="color:#34495e">】。</font></p><p><font style="color:#34495e">如</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">max_connection =&gt; 10000</font><font style="color:#34495e">, 此参数用来设置</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">Server</font><font style="color:#34495e"> </font><font style="color:#34495e">最大允许维持多少个</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">TCP</font><font style="color:#34495e"> </font><font style="color:#34495e">连接。超过此数量后，新进入的连接将被拒绝。</font></p><ul><li><strong><font style="color:#2c3e50">提示</font></strong><ul><li><strong><font style="color:#2c3e50">默认设置</font></strong><ul><li><font style="color:#34495e">应用层未设置 </font><font style="color:#e96900;background-color:#f8f8f8">max_connection</font><font style="color:#34495e">，底层将使用 </font><font style="color:#e96900;background-color:#f8f8f8">ulimit -n</font><font style="color:#34495e"> 的值作为缺省设置</font></li><li><font style="color:#34495e">在 </font><font style="color:#e96900;background-color:#f8f8f8">4.2.9</font><font style="color:#34495e"> 或更高版本，当底层检测到 </font><font style="color:#e96900;background-color:#f8f8f8">ulimit -n</font><font style="color:#34495e"> 超过 </font><font style="color:#e96900;background-color:#f8f8f8">100000</font><font style="color:#34495e"> 时将默认设置为 </font><font style="color:#e96900;background-color:#f8f8f8">100000</font><font style="color:#34495e">，原因是某些系统设置了 </font><font style="color:#e96900;background-color:#f8f8f8">ulimit -n</font><font style="color:#34495e"> 为 </font><font style="color:#e96900;background-color:#f8f8f8">100 万</font><font style="color:#34495e">，需要分配大量内存，导致启动失败</font></li></ul></li><li><strong><font style="color:#2c3e50">最大上限</font></strong><ul><li><font style="color:#34495e">请勿设置</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">max_connection</font><font style="color:#34495e"> </font><font style="color:#34495e">超过</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">1M</font></li></ul></li><li><strong><font style="color:#2c3e50">最小设置</font></strong><ul><li><font style="color:#34495e">此选项设置过小底层会抛出错误，并设置为</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">ulimit -n</font><font style="color:#34495e"> </font><font style="color:#34495e">的值。</font></li><li><font style="color:#34495e">最小值为 </font><font style="color:#e96900;background-color:#f8f8f8">(worker_num + task_worker_num) * 2 + 32</font></li></ul></li></ul></li></ul><blockquote><p>serv-&gt;max_connection is too small.</p></blockquote><pre><code>- **&lt;font style=&quot;color:rgb(44, 62, 80);&quot;&gt;内存占用&lt;/font&gt;**
    * &lt;font style=&quot;color:rgb(233, 105, 0);background-color:rgb(248, 248, 248);&quot;&gt;max_connection&lt;/font&gt;&lt;font style=&quot;color:rgb(52, 73, 94);&quot;&gt; 参数不要调整的过大，根据机器内存的实际情况来设置。&lt;/font&gt;&lt;font style=&quot;color:rgb(233, 105, 0);background-color:rgb(248, 248, 248);&quot;&gt;Swoole&lt;/font&gt;&lt;font style=&quot;color:rgb(52, 73, 94);&quot;&gt; 会根据此数值一次性分配一块大内存来保存 &lt;/font&gt;&lt;font style=&quot;color:rgb(233, 105, 0);background-color:rgb(248, 248, 248);&quot;&gt;Connection&lt;/font&gt;&lt;font style=&quot;color:rgb(52, 73, 94);&quot;&gt; 信息，一个 &lt;/font&gt;&lt;font style=&quot;color:rgb(233, 105, 0);background-color:rgb(248, 248, 248);&quot;&gt;TCP&lt;/font&gt;&lt;font style=&quot;color:rgb(52, 73, 94);&quot;&gt; 连接的 &lt;/font&gt;&lt;font style=&quot;color:rgb(233, 105, 0);background-color:rgb(248, 248, 248);&quot;&gt;Connection&lt;/font&gt;&lt;font style=&quot;color:rgb(52, 73, 94);&quot;&gt; 信息，需要占用 &lt;/font&gt;&lt;font style=&quot;color:rgb(233, 105, 0);background-color:rgb(248, 248, 248);&quot;&gt;224&lt;/font&gt;&lt;font style=&quot;color:rgb(52, 73, 94);&quot;&gt; 字节。&lt;/font&gt;
</code></pre><ul><li><strong><font style="color:#2c3e50">注意</font></strong></li></ul><blockquote><p><font style="color:#e96900;background-color:#efefef">max_connection</font><font style="color:#34495e;background-color:#f8f8f8"> 最大不得超过操作系统 </font><font style="color:#e96900;background-color:#efefef">ulimit -n</font><font style="color:#34495e;background-color:#f8f8f8"> 的值，否则会报一条警告信息，并重置为 </font><font style="color:#e96900;background-color:#efefef">ulimit -n</font><font style="color:#34495e;background-color:#f8f8f8"> 的值</font></p></blockquote><blockquote><p>WARN swServer_start_check: serv-&gt;max_conn is exceed the maximum value[100000]. WARNING set_max_connection: max_connection is exceed the maximum value, it’s reset to 10240</p></blockquote><h2 id="task-worker-num"><a href="#task-worker-num" class="headerlink" title="task_worker_num"></a>task_worker_num</h2><p><strong><font style="color:#2c3e50">配置</font>**</strong><font style="color:#2c3e50"> </font><strong><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/learn?id=taskworker%e8%bf%9b%e7%a8%8b">Task 进程</a></strong><font style="color:#2c3e50">的数量。</font>**</p><p><font style="color:#34495e">配置此参数后将会启用</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">task</font><font style="color:#34495e"> </font><font style="color:#34495e">功能。所以</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">Server</font><font style="color:#34495e"> </font><font style="color:#34495e">务必要注册</font><font style="color:#34495e"> </font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/server/events?id=ontask">onTask</a><font style="color:#34495e">、</font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/server/events?id=onfinish">onFinish</a><font style="color:#34495e"> </font><font style="color:#34495e">2 个事件回调函数。如果没有注册，服务器程序将无法启动。</font></p><ul><li><strong><font style="color:#2c3e50">提示</font></strong><ul><li><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/learn?id=taskworker%e8%bf%9b%e7%a8%8b">Task 进程</a><font style="color:#34495e">是同步阻塞的</font></li><li><font style="color:#34495e">最大值不得超过</font><font style="color:#34495e"> </font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/functions?id=swoole_cpu_num">swoole_cpu_num()</a><font style="color:#34495e"> </font><font style="color:#34495e">* 1000</font></li><li><strong><font style="color:#2c3e50">计算方法</font></strong><ul><li><font style="color:#34495e">单个</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">task</font><font style="color:#34495e"> </font><font style="color:#34495e">的处理耗时，如</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">100ms</font><font style="color:#34495e">，那一个进程 1 秒就可以处理</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">1/0.1=10</font><font style="color:#34495e"> </font><font style="color:#34495e">个 task</font></li><li><font style="color:#e96900;background-color:#f8f8f8">task</font><font style="color:#34495e"> </font><font style="color:#34495e">投递的速度，如每秒产生</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">2000</font><font style="color:#34495e"> </font><font style="color:#34495e">个</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">task</font></li><li><font style="color:#e96900;background-color:#f8f8f8">2000/10=200</font><font style="color:#34495e">，需要设置</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">task_worker_num =&gt; 200</font><font style="color:#34495e">，启用</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">200</font><font style="color:#34495e"> </font><font style="color:#34495e">个 Task 进程</font></li></ul></li></ul></li><li><strong><font style="color:#2c3e50">注意</font></strong></li></ul><blockquote><p><font style="color:#34495e;background-color:#f8f8f8"></font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/learn?id=taskworker%e8%bf%9b%e7%a8%8b">Task 进程</a><font style="color:#34495e;background-color:#f8f8f8">内不能使用 </font><font style="color:#e96900;background-color:#efefef">Swoole\Server-&gt;task</font><font style="color:#34495e;background-color:#f8f8f8"> 方法</font></p></blockquote><h2 id="task-max-request"><a href="#task-max-request" class="headerlink" title="task_max_request"></a>task_max_request</h2><p><strong><font style="color:#2c3e50">设置</font>**</strong><font style="color:#2c3e50"> </font><strong><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/learn?id=taskworker%e8%bf%9b%e7%a8%8b">task 进程</a></strong><font style="color:#2c3e50">的最大任务数。</font>**<font style="color:#34495e">【默认值：</font><font style="color:#e96900;background-color:#f8f8f8">0</font><font style="color:#34495e">】</font></p><p><font style="color:#34495e">设置 task 进程的最大任务数。一个 task 进程在处理完超过此数值的任务后将自动退出。这个参数是为了防止 PHP 进程内存溢出。如果不希望进程自动退出可以设置为 0。</font></p><h2 id="heartbeat-check-interval"><a href="#heartbeat-check-interval" class="headerlink" title="heartbeat_check_interval"></a>heartbeat_check_interval</h2><p><strong><font style="color:#2c3e50">启用心跳检测</font></strong><font style="color:#34495e">【默认值：</font><font style="color:#e96900;background-color:#f8f8f8">false</font><font style="color:#34495e">】</font></p><p><font style="color:#34495e">此选项表示每隔多久轮循一次，单位为秒。如</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">heartbeat_check_interval =&gt; 60</font><font style="color:#34495e">，表示每</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">60</font><font style="color:#34495e"> </font><font style="color:#34495e">秒，遍历所有连接，如果该连接在</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">120</font><font style="color:#34495e"> </font><font style="color:#34495e">秒内（</font><font style="color:#e96900;background-color:#f8f8f8">heartbeat_idle_time</font><font style="color:#34495e"> </font><font style="color:#34495e">未设置时默认为</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">interval</font><font style="color:#34495e"> </font><font style="color:#34495e">的两倍），没有向服务器发送任何数据，此连接将被强制关闭。若未配置，则不会启用心跳，该配置默认关闭，参考</font><font style="color:#34495e"> </font><a target="_blank" rel="noopener" href="https://course.swoole-cloud.com/course-video/10">Swoole 官方视频教程</a><font style="color:#34495e">。</font></p><ul><li><strong><font style="color:#2c3e50">提示</font></strong><ul><li><font style="color:#e96900;background-color:#f8f8f8">Server</font><font style="color:#34495e"> </font><font style="color:#34495e">并不会主动向客户端发送心跳包，而是被动等待客户端发送心跳。服务器端的</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">heartbeat_check</font><font style="color:#34495e"> </font><font style="color:#34495e">仅仅是检测连接上一次发送数据的时间，如果超过限制，将切断连接。</font></li><li><font style="color:#34495e">被心跳检测切断的连接依然会触发</font><font style="color:#34495e"> </font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/server/events?id=onclose">onClose</a><font style="color:#34495e"> </font><font style="color:#34495e">事件回调</font></li></ul></li><li><strong><font style="color:#2c3e50">注意 </font></strong><font style="color:#e96900;background-color:#efefef">heartbeat_check</font><font style="color:#34495e;background-color:#f8f8f8"> 仅支持 </font><font style="color:#e96900;background-color:#efefef">TCP</font><font style="color:#34495e;background-color:#f8f8f8"> 连接</font></li></ul><h2 id="heartbeat-idle-time"><a href="#heartbeat-idle-time" class="headerlink" title="heartbeat_idle_time"></a>heartbeat_idle_time</h2><p><strong><font style="color:#2c3e50">连接最大允许空闲的时间</font></strong></p><p><font style="color:#34495e">需要与</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">heartbeat_check_interval</font><font style="color:#34495e"> </font><font style="color:#34495e">配合使用</font></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span>(</span><br><span class="line">  	<span class="comment">// 表示一个连接如果600秒内未向服务器发送任何数据，此连接将被强制关闭</span></span><br><span class="line">    <span class="string">&#x27;heartbeat_idle_time&#x27;</span> =&gt; <span class="number">600</span>,</span><br><span class="line">    <span class="comment">// 表示每60秒遍历一次</span></span><br><span class="line">    <span class="string">&#x27;heartbeat_check_interval&#x27;</span> =&gt; <span class="number">60</span>,</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ul><li><strong><font style="color:#2c3e50">提示</font></strong><ul><li><font style="color:#34495e">启用</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">heartbeat_idle_time</font><font style="color:#34495e"> </font><font style="color:#34495e">后，服务器并不会主动向客户端发送数据包</font></li><li><font style="color:#34495e">如果只设置了 </font><font style="color:#e96900;background-color:#f8f8f8">heartbeat_idle_time</font><font style="color:#34495e"> 未设置 </font><font style="color:#e96900;background-color:#f8f8f8">heartbeat_check_interval</font><font style="color:#34495e"> 底层将不会创建心跳检测线程，</font><font style="color:#e96900;background-color:#f8f8f8">PHP</font><font style="color:#34495e"> 代码中可以调用 </font><font style="color:#e96900;background-color:#f8f8f8">heartbeat</font><font style="color:#34495e"> 方法手动处理超时的连接</font></li></ul></li></ul><h2 id="reload-async"><a href="#reload-async" class="headerlink" title="reload_async"></a>reload_async</h2><p><strong><font style="color:#2c3e50">设置异步重启开关。</font></strong><font style="color:#34495e">【默认值：</font><font style="color:#e96900;background-color:#f8f8f8">true</font><font style="color:#34495e">】</font></p><p><font style="color:#34495e">设置异步重启开关。设置为</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">true</font><font style="color:#34495e"> </font><font style="color:#34495e">时，将启用异步安全重启特性，</font><font style="color:#e96900;background-color:#f8f8f8">Worker</font><font style="color:#34495e"> </font><font style="color:#34495e">进程会等待异步事件完成后再退出。详细信息请参见</font><font style="color:#34495e"> </font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/question/use?id=swoole%e5%a6%82%e4%bd%95%e6%ad%a3%e7%a1%ae%e7%9a%84%e9%87%8d%e5%90%af%e6%9c%8d%e5%8a%a1">如何正确的重启服务</a></p><p><font style="color:#e96900;background-color:#f8f8f8">reload_async</font><font style="color:#34495e"> </font><font style="color:#34495e">开启的主要目的是为了保证服务重载时，协程或异步任务能正常结束。</font></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$server</span>-&gt;set([<span class="string">&#x27;reload_async&#x27;</span> =&gt; <span class="literal">true</span>]);</span><br></pre></td></tr></table></figure><ul><li><strong><font style="color:#2c3e50">协程模式</font></strong><ul><li><font style="color:#34495e">在 </font><font style="color:#e96900;background-color:#f8f8f8">4.x</font><font style="color:#34495e"> 版本中开启 </font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/server/setting?id=enable_coroutine">enable_coroutine</a><font style="color:#34495e"> 时，底层会额外增加一个协程数量的检测，当前无任何协程时进程才会退出，开启时即使 </font><font style="color:#e96900;background-color:#f8f8f8">reload_async =&gt; false</font><font style="color:#34495e"> 也会强制打开 </font><font style="color:#e96900;background-color:#f8f8f8">reload_async</font><font style="color:#34495e">。</font></li></ul></li></ul><h2 id="max-wait-time"><a href="#max-wait-time" class="headerlink" title="max_wait_time"></a>max_wait_time</h2><p><strong><font style="color:#2c3e50">设置</font>**</strong><font style="color:#2c3e50"> </font>*<strong>*<font style="color:#e96900;background-color:#f8f8f8">Worker</font>**</strong><font style="color:#2c3e50"> </font>*<strong>*<font style="color:#2c3e50">进程收到停止服务通知后最大等待时间</font></strong><font style="color:#34495e">【默认值：</font><font style="color:#e96900;background-color:#f8f8f8">3</font><font style="color:#34495e">】</font></p><p><font style="color:#34495e">经常会碰到由于</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">worker</font><font style="color:#34495e"> </font><font style="color:#34495e">阻塞卡顿导致</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">worker</font><font style="color:#34495e"> </font><font style="color:#34495e">无法正常</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">reload</font><font style="color:#34495e">, 无法满足一些生产场景，例如发布代码热更新需要</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">reload</font><font style="color:#34495e"> </font><font style="color:#34495e">进程。所以，Swoole 加入了进程重启超时时间的选项。详细信息请参见</font><font style="color:#34495e"> </font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/question/use?id=swoole%e5%a6%82%e4%bd%95%e6%ad%a3%e7%a1%ae%e7%9a%84%e9%87%8d%e5%90%af%e6%9c%8d%e5%8a%a1">如何正确的重启服务</a></p><ul><li><strong><font style="color:#2c3e50">提示</font></strong><ul><li><strong><font style="color:#2c3e50">管理进程收到重启、关闭信号后或者达到</font>**</strong><font style="color:#2c3e50"> </font>*<strong>*<font style="color:#e96900;background-color:#f8f8f8">max_request</font>**</strong><font style="color:#2c3e50"> </font>*<strong>*<font style="color:#2c3e50">时，管理进程会重起该</font>**</strong><font style="color:#2c3e50"> </font>*<strong>*<font style="color:#e96900;background-color:#f8f8f8">worker</font>**</strong><font style="color:#2c3e50"> </font>*<strong>*<font style="color:#2c3e50">进程。分以下几个步骤：</font></strong><ul><li><font style="color:#34495e">底层会增加一个 (</font><font style="color:#e96900;background-color:#f8f8f8">max_wait_time</font><font style="color:#34495e">) 秒的定时器，触发定时器后，检查进程是否依然存在，如果是，会强制杀掉，重新拉一个进程。</font></li><li><font style="color:#34495e">需要在</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">onWorkerStop</font><font style="color:#34495e"> </font><font style="color:#34495e">回调里面做收尾工作，需要在</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">max_wait_time</font><font style="color:#34495e"> </font><font style="color:#34495e">秒内做完收尾。</font></li><li><font style="color:#34495e">依次向目标进程发送</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">SIGTERM</font><font style="color:#34495e"> </font><font style="color:#34495e">信号，杀掉进程。</font></li></ul></li></ul></li><li><strong><font style="color:#2c3e50">注意</font></strong></li></ul><blockquote><p><font style="color:#e96900;background-color:#efefef">v4.4.x</font><font style="color:#34495e;background-color:#f8f8f8"> 以前默认为 </font><font style="color:#e96900;background-color:#efefef">30</font><font style="color:#34495e;background-color:#f8f8f8"> 秒</font></p></blockquote><h2 id="enable-coroutine"><a href="#enable-coroutine" class="headerlink" title="enable_coroutine"></a>enable_coroutine</h2><p><strong><font style="color:#2c3e50">是否启用异步风格服务器的协程支持</font></strong></p><p><font style="color:#e96900;background-color:#f8f8f8">enable_coroutine</font><font style="color:#34495e"> </font><font style="color:#34495e">关闭时在</font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/server/events">事件回调函数</a><font style="color:#34495e">中不再自动创建协程，如果不需要用协程关闭这个会提高一些性能。参考</font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/coroutine">什么是 Swoole 协程</a><font style="color:#34495e">。</font></p><ul><li><strong><font style="color:#2c3e50">配置方法</font></strong><ul><li><font style="color:#34495e">在</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">php.ini</font><font style="color:#34495e"> </font><font style="color:#34495e">配置</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">swoole.enable_coroutine = ‘Off’</font><font style="color:#34495e"> </font><font style="color:#34495e">(可见</font><font style="color:#34495e"> </font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/other/config">ini 配置文档</a><font style="color:#34495e"> </font><font style="color:#34495e">)</font></li><li><font style="color:#e96900;background-color:#f8f8f8">$server-&gt;set([‘enable_coroutine’ =&gt; false]);</font><font style="color:#34495e"> </font><font style="color:#34495e">优先级高于 ini</font></li></ul></li><li><strong><font style="color:#e96900;background-color:#f8f8f8">enable_coroutine</font>**</strong><font style="color:#2c3e50"> </font>*<strong>*<font style="color:#2c3e50">选项影响范围</font></strong><ul><li><font style="color:#34495e">onWorkerStart</font></li><li><font style="color:#34495e">onConnect</font></li><li><font style="color:#34495e">onOpen</font></li><li><font style="color:#34495e">onReceive</font></li><li><font style="color:#34495e">setHandler</font></li><li><font style="color:#34495e">onPacket</font></li><li><font style="color:#34495e">onRequest</font></li><li><font style="color:#34495e">onMessage</font></li><li><font style="color:#34495e">onPipeMessage</font></li><li><font style="color:#34495e">onFinish</font></li><li><font style="color:#34495e">onClose</font></li><li><font style="color:#34495e">tick/after 定时器</font></li></ul></li></ul><p><font style="color:#34495e;background-color:#f8f8f8">开启</font><font style="color:#34495e;background-color:#f8f8f8"> </font><font style="color:#e96900;background-color:#efefef">enable_coroutine</font><font style="color:#34495e;background-color:#f8f8f8"> </font><font style="color:#34495e;background-color:#f8f8f8">后在上述回调函数会自动创建协程</font></p><ul><li><font style="color:#34495e">当</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">enable_coroutine</font><font style="color:#34495e"> </font><font style="color:#34495e">设置为</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">true</font><font style="color:#34495e"> </font><font style="color:#34495e">时，底层自动在</font><font style="color:#34495e"> </font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/http_server?id=on">onRequest</a><font style="color:#34495e"> </font><font style="color:#34495e">回调中创建协程，开发者无需自行使用</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">go</font><font style="color:#34495e"> </font><font style="color:#34495e">函数</font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/coroutine/coroutine?id=create">创建协程</a></li><li><font style="color:#34495e">当 </font><font style="color:#e96900;background-color:#f8f8f8">enable_coroutine</font><font style="color:#34495e"> 设置为 </font><font style="color:#e96900;background-color:#f8f8f8">false</font><font style="color:#34495e"> 时，底层不会自动创建协程，开发者如果要使用协程，必须使用 </font><font style="color:#e96900;background-color:#f8f8f8">go</font><font style="color:#34495e"> 自行创建协程，如果不需要使用协程特性，则处理方式与 </font><font style="color:#e96900;background-color:#f8f8f8">Swoole1.x</font><font style="color:#34495e"> 是 100% 一致的</font></li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$server</span> = <span class="keyword">new</span> Swoole\Http\Server(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9501</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$server</span>-&gt;set([</span><br><span class="line">    <span class="comment">//关闭内置协程</span></span><br><span class="line">    <span class="string">&#x27;enable_coroutine&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="variable">$server</span>-&gt;on(<span class="string">&quot;request&quot;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$request</span>, <span class="variable">$response</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$request</span>-&gt;server[<span class="string">&#x27;request_uri&#x27;</span>] == <span class="string">&#x27;/coro&#x27;</span>) &#123;</span><br><span class="line">        go(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="keyword">use</span> (<span class="params"><span class="variable">$response</span></span>) </span>&#123;</span><br><span class="line">            co::sleep(<span class="number">0.2</span>);</span><br><span class="line">            <span class="variable">$response</span>-&gt;header(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/plain&quot;</span>);</span><br><span class="line">            <span class="variable">$response</span>-&gt;end(<span class="string">&quot;Hello World\n&quot;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$response</span>-&gt;header(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/plain&quot;</span>);</span><br><span class="line">        <span class="variable">$response</span>-&gt;end(<span class="string">&quot;Hello World\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable">$server</span>-&gt;start();</span><br></pre></td></tr></table></figure><h2 id="task-enable-coroutine"><a href="#task-enable-coroutine" class="headerlink" title="task_enable_coroutine"></a>task_enable_coroutine</h2><p><strong><font style="color:#2c3e50">开启</font>**</strong><font style="color:#2c3e50"> </font>*<strong>*<font style="color:#e96900;background-color:#f8f8f8">Task</font>**</strong><font style="color:#2c3e50"> </font>*<strong>*<font style="color:#2c3e50">协程支持。</font></strong><font style="color:#34495e">【默认值：</font><font style="color:#e96900;background-color:#f8f8f8">false</font><font style="color:#34495e">】，v4.2.12 起支持</font></p><p><font style="color:#34495e">开启后自动在 </font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/server/events?id=ontask">onTask</a><font style="color:#34495e"> 回调中创建协程和</font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/coroutine/scheduler">协程容器</a><font style="color:#34495e">，</font><font style="color:#e96900;background-color:#f8f8f8">PHP</font><font style="color:#34495e"> 代码可以直接使用协程 </font><font style="color:#e96900;background-color:#f8f8f8">API</font><font style="color:#34495e">。</font></p><ul><li><strong><font style="color:#2c3e50">示例</font></strong></li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$server</span>-&gt;on(<span class="string">&#x27;Task&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$serv</span>, Swoole\Server\Task <span class="variable">$task</span></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//来自哪个 Worker 进程</span></span><br><span class="line">    <span class="variable">$task</span>-&gt;worker_id;</span><br><span class="line">    <span class="comment">//任务的编号</span></span><br><span class="line">    <span class="variable">$task</span>-&gt;id;</span><br><span class="line">    <span class="comment">//任务的类型，taskwait, task, taskCo, taskWaitMulti 可能使用不同的 flags</span></span><br><span class="line">    <span class="variable">$task</span>-&gt;flags;</span><br><span class="line">    <span class="comment">//任务的数据</span></span><br><span class="line">    <span class="variable">$task</span>-&gt;data;</span><br><span class="line">    <span class="comment">//投递时间，v4.6.0版本增加</span></span><br><span class="line">    <span class="variable">$task</span>-&gt;dispatch_time;</span><br><span class="line">    <span class="comment">//协程 API</span></span><br><span class="line">    co::sleep(<span class="number">0.2</span>);</span><br><span class="line">    <span class="comment">//完成任务，结束并返回数据</span></span><br><span class="line">    <span class="variable">$task</span>-&gt;finish([<span class="number">123</span>, <span class="string">&#x27;hello&#x27;</span>]);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li><strong><font style="color:#2c3e50">注意</font></strong></li></ul><blockquote><p><font style="color:#e96900;background-color:#efefef">task_enable_coroutine</font><font style="color:#34495e;background-color:#f8f8f8"> 必须在 </font><a target="_blank" rel="noopener" href="https://wiki.swoole.com/#/server/setting?id=enable_coroutine">enable_coroutine</a><font style="color:#34495e;background-color:#f8f8f8"> 为 </font><font style="color:#e96900;background-color:#efefef">true</font><font style="color:#34495e;background-color:#f8f8f8"> 时才可以使用<br></font><font style="color:#34495e;background-color:#f8f8f8">开启 </font><font style="color:#e96900;background-color:#efefef">task_enable_coroutine</font><font style="color:#34495e;background-color:#f8f8f8">，</font><font style="color:#e96900;background-color:#efefef">Task</font><font style="color:#34495e;background-color:#f8f8f8"> 工作进程支持协程<br></font><font style="color:#34495e;background-color:#f8f8f8">未开启 </font><font style="color:#e96900;background-color:#efefef">task_enable_coroutine</font><font style="color:#34495e;background-color:#f8f8f8">，仅支持同步阻塞</font></p></blockquote><h2 id="max-coroutine-max-coro-num"><a href="#max-coroutine-max-coro-num" class="headerlink" title="max_coroutine/max_coro_num"></a>max_coroutine/max_coro_num</h2><p><strong><font style="color:#2c3e50">设置当前工作进程最大协程数量。</font></strong><font style="color:#34495e">【默认值：</font><font style="color:#e96900;background-color:#f8f8f8">100000</font><font style="color:#34495e">，Swoole 版本小于</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">v4.4.0-beta</font><font style="color:#34495e"> </font><font style="color:#34495e">时默认值为</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">3000</font><font style="color:#34495e">】</font></p><p><font style="color:#34495e">超过</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">max_coroutine</font><font style="color:#34495e"> </font><font style="color:#34495e">底层将无法创建新的协程，服务端的 Swoole 会抛出</font><font style="color:#34495e"> </font><font style="color:#e96900;background-color:#f8f8f8">exceed max number of coroutine</font><font style="color:#34495e"> </font><font style="color:#34495e">错误，</font><font style="color:#e96900;background-color:#f8f8f8">TCP Server</font><font style="color:#34495e"> </font><font style="color:#34495e">会直接关闭连接，</font><font style="color:#e96900;background-color:#f8f8f8">Http Server</font><font style="color:#34495e"> </font><font style="color:#34495e">会返回 Http 的 503 状态码。</font></p><p><font style="color:#34495e">在 </font><font style="color:#e96900;background-color:#f8f8f8">Server</font><font style="color:#34495e"> 程序中实际最大可创建协程数量等于 </font><font style="color:#e96900;background-color:#f8f8f8">worker_num * max_coroutine</font><font style="color:#34495e">，task 进程和 UserProcess 进程的协程数量单独计算。</font></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$server</span>-&gt;set(<span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;max_coroutine&#x27;</span> =&gt; <span class="number">3000</span>,</span><br><span class="line">));</span><br></pre></td></tr></table></figure></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="https://g-ydg.github.io/2023/03/24/Swoole%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE/" title="Swoole常用配置" target="_blank" rel="external">https://g-ydg.github.io/2023/03/24/Swoole常用配置/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote></div></article><section id="comments"></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2023/03/24/SwooleCoroutine/" title="SwooleCoroutine"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a></li><li class="next"><a href="/2023/03/24/PHP%E7%9A%84%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F/" title="PHP的内存泄漏"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li></ul><button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button><div class="bar-right"><div class="share-component" data-sites="weibo,qq,wechat" data-mobile-sites="weibo,qq,qzone"></div></div></div></nav><div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content donate"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><div class="modal-body"><div class="donate-box"><div class="donate-head"><p>感谢您的支持，我会继续努力的!</p></div><div class="tab-content"><div role="tabpanel" class="tab-pane fade active in" id="alipay"><div class="donate-payimg"><img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p></div><div role="tabpanel" class="tab-pane fade" id="wechatpay"><div class="donate-payimg"><img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p></div></div><div class="donate-footer"><ul class="nav nav-tabs nav-justified" role="tablist"><li role="presentation" class="active"><a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a></li><li role="presentation"><a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a></li></ul></div></div></div></div></div></div></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/g-ydg" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div class="copyright">&copy; 2025 Ydd<div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>window.INSIGHT_CONFIG={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"}</script><script src="/js/insight.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>